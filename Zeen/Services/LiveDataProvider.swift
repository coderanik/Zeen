import Foundation

/// A data provider backed by real user behavior tracked via ActivityTracker.
/// Conforms to ZeenDataProviding so it's a drop-in replacement for MockDataProvider.
@MainActor
struct LiveDataProvider: ZeenDataProviding {

    private let tracker: ActivityTracker

    init(tracker: ActivityTracker = .shared) {
        self.tracker = tracker
    }

    func todayInput() -> DriftInput {
        tracker.todayDriftInput()
    }

    func timelineForToday() -> [TimelinePoint] {
        tracker.hourlyTimeline()
    }

    func weeklySummary() -> WeeklySummary {
        tracker.weeklySummary()
    }

    // MARK: - Historical Data (for Calendar)

    func historicalRecords(days: Int) -> [DailyRecord] {
        tracker.historicalRecords(days: days)
    }

    // MARK: - Export Report

    static func exportReport(daily: DailySummary, weekly: WeeklySummary, profile: String?) -> String {
        let dateFormatter = DateFormatter()
        dateFormatter.dateStyle = .medium

        let dayNames = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"]

        var lines: [String] = []
        lines.append("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
        lines.append("â•‘       ZEEN WEEKLY REPORT         â•‘")
        lines.append("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
        lines.append("")

        if let name = profile {
            lines.append("ğŸ‘¤ \(name)")
        }
        lines.append("ğŸ“… Week of \(dateFormatter.string(from: weekly.weekStart))")
        lines.append("")
        lines.append("â”€â”€â”€ Today â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
        lines.append("\(daily.score.level.emoji) Drift Score: \(daily.score.value)/100 (\(daily.score.level.label))")
        lines.append("ğŸ• Calm Hours: \(daily.calmHourCount)")
        lines.append("")

        lines.append("â”€â”€â”€ This Week â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
        lines.append("ğŸ“Š Average: \(weekly.averageScore)")
        lines.append("ğŸ§˜ Deep Focus: \(weekly.totalDeepFocusMinutes) min")
        lines.append("")
        lines.append("   Day   Score   Focus")

        for point in weekly.points {
            let name = dayNames[point.dayIndex % 7]
            let bar = String(repeating: "â–ˆ", count: point.score / 10)
            lines.append("   \(name)   \(String(format: "%3d", point.score))    \(point.deepFocusMinutes)m  \(bar)")
        }

        lines.append("")
        lines.append("â”€â”€â”€ Factors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
        for factor in daily.score.factors {
            lines.append("  \(factor.title): +\(factor.contribution) (observed: \(factor.observed))")
        }

        lines.append("")
        lines.append("Generated by Zeen Â· zeen.app")

        return lines.joined(separator: "\n")
    }
}
